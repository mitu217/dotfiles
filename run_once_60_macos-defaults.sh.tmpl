{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -eu

echo "==> Configuring macOS defaults..."

# Show ~/Library directory
chflags nohidden ~/Library

# Show /Volumes directory
sudo chflags nohidden /Volumes

# Disable boot sound
sudo nvram SystemAudioVolume=" "

# Disable window animations
defaults write -g NSAutomaticWindowAnimationsEnabled -bool false

# Remove tooltip delay
defaults write -g NSInitialToolTipDelay -integer 0

# Speed up dialog and window resize
defaults write -g NSWindowResizeTime 0.1

# Show all file extensions
defaults write NSGlobalDomain AppleShowAllExtensions -bool true

# Always show scrollbars
defaults write NSGlobalDomain AppleShowScrollBars -string "Always"

# Remove spring-load delay
defaults write NSGlobalDomain com.apple.springing.delay -float 0
defaults write NSGlobalDomain com.apple.springing.enabled -bool true

# Key repeat settings
defaults write NSGlobalDomain KeyRepeat -int 2
defaults write NSGlobalDomain InitialKeyRepeat -int 15

# Speed up console window resize
defaults write NSGlobalDomain NSWindowResizeTime -float 0.001

# Improve Bluetooth audio quality
defaults write com.apple.BluetoothAudioAgent "Apple Bitpool Min (editable)" -int 40

# Disable crash reporter
defaults write com.apple.CrashReporter DialogType -string "none"

# Don't create .DS_Store on network/USB volumes
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

# Dock settings
defaults write com.apple.dock autohide-delay -float 0
defaults write com.apple.dock mcx-expose-disabled -bool false
defaults write com.apple.dock tilesize -int 42
defaults write com.apple.dock show-recents -bool false
# Reset Dock apps to Settings only (Finder is always shown)
defaults write com.apple.dock persistent-apps -array \
  '<dict><key>tile-data</key><dict><key>file-data</key><dict><key>_CFURLString</key><string>file:///System/Applications/System%20Settings.app/</string><key>_CFURLStringType</key><integer>15</integer></dict></dict></dict>'
killall Dock

# Finder settings
defaults write com.apple.finder AppleShowAllFiles YES
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false

# Disable app verification dialog
defaults write com.apple.LaunchServices LSQuarantine -bool false

# Screenshot settings
defaults write com.apple.screencapture disable-shadow -bool true
defaults write com.apple.screencapture type -string "png"

# Terminal UTF-8 only
defaults write com.apple.terminal StringEncodings -array 4

# Remap modifier keys for HHKB-Hybrid (VendorID:1278 ProductID:33)
# Caps Lock -> Right Command, Control <-> Command (both sides)
defaults -currentHost delete -g com.apple.keyboard.modifiermapping.1278-33-0 2>/dev/null || true
defaults -currentHost write -g com.apple.keyboard.modifiermapping.1278-33-0 -array \
  '<dict><key>HIDKeyboardModifierMappingDst</key><integer>30064771303</integer><key>HIDKeyboardModifierMappingSrc</key><integer>30064771129</integer></dict>' \
  '<dict><key>HIDKeyboardModifierMappingDst</key><integer>30064771300</integer><key>HIDKeyboardModifierMappingSrc</key><integer>30064771303</integer></dict>' \
  '<dict><key>HIDKeyboardModifierMappingDst</key><integer>30064771303</integer><key>HIDKeyboardModifierMappingSrc</key><integer>30064771300</integer></dict>' \
  '<dict><key>HIDKeyboardModifierMappingDst</key><integer>30064771299</integer><key>HIDKeyboardModifierMappingSrc</key><integer>30064771296</integer></dict>' \
  '<dict><key>HIDKeyboardModifierMappingDst</key><integer>30064771296</integer><key>HIDKeyboardModifierMappingSrc</key><integer>30064771299</integer></dict>'

# Keyboard shortcuts
# Key 60: Select previous input source -> Cmd+Space
# Key 64: Show Spotlight search -> Ctrl+Space
/usr/libexec/PlistBuddy -c "Set :AppleSymbolicHotKeys:60:value:parameters:2 1048576" ~/Library/Preferences/com.apple.symbolichotkeys.plist
/usr/libexec/PlistBuddy -c "Set :AppleSymbolicHotKeys:64:value:parameters:2 262144" ~/Library/Preferences/com.apple.symbolichotkeys.plist

# Show Screen Mirroring in menu bar (always)
defaults -currentHost write com.apple.controlcenter ScreenMirroring -int 18

# Disable click desktop to show desktop
defaults write com.apple.WindowManager EnableStandardClickToShowDesktop -bool false

# Disable natural scrolling for mouse
defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false

# Disable live conversion (Japanese input)
defaults write com.apple.inputmethod.Kotoeri JIMPrefLiveConversionKey -bool false

# Set timezone to Asia/Tokyo
sudo systemsetup -settimezone Asia/Tokyo

echo "macOS defaults configured successfully"
{{- end }}
