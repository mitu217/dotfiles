{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -eu

echo "==> Setting up 1Password SSH agent..."

AGENT_SOCK="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
SYMLINK_DIR="$HOME/.1password"
SYMLINK_PATH="$SYMLINK_DIR/agent.sock"

# Create symlink directory
mkdir -p "$SYMLINK_DIR"

# Create symlink to 1Password SSH agent socket
if [ -L "$SYMLINK_PATH" ]; then
    echo "Symlink already exists: $SYMLINK_PATH"
elif [ -e "$SYMLINK_PATH" ]; then
    echo "Warning: $SYMLINK_PATH exists but is not a symlink, skipping"
else
    ln -s "$AGENT_SOCK" "$SYMLINK_PATH"
    echo "Created symlink: $SYMLINK_PATH -> $AGENT_SOCK"
fi

# Create 1Password SSH agent config directory
mkdir -p "$HOME/.config/1Password/ssh"

# Check if SSH agent is enabled
if [ -S "$AGENT_SOCK" ]; then
    echo "1Password SSH agent is active"
else
    echo ""
    echo "=========================================="
    echo " ACTION REQUIRED: Enable 1Password SSH Agent"
    echo "=========================================="
    echo ""
    echo " 1. Open 1Password"
    echo " 2. Go to Settings > Developer"
    echo " 3. Enable 'SSH Agent'"
    echo ""
    echo " Then run 'ssh-add -L' to verify"
    echo "=========================================="
fi

echo "1Password SSH agent setup complete"
{{- end }}
